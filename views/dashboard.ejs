<% 
    // ==========================================
    // 1. FILTROS E CONTAGENS BÃSICAS
    // ==========================================
    const totalItens = data.estoque.length;
    
    // Itens CrÃ­ticos (Abaixo do alerta e mensurÃ¡veis)
    const criticosRaw = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta && 
        i.consumo_mensuravel === 1
    );

    // ORDENAÃ‡ÃƒO POR TÃ‰RMINO (O que acaba antes no topo)
    const criticos = criticosRaw.sort((a, b) => {
        const converterData = (dataStr) => {
            if (!dataStr || dataStr === 'N/A' || dataStr === 'Sem previsÃ£o') return new Date(8640000000000000);
            const [dia, mes, ano] = dataStr.split('/');
            return new Date(ano, mes - 1, dia);
        };
        const dataA = converterData(a.previsaoFim);
        const dataB = converterData(b.previsaoFim);
        
        // Se as datas forem iguais, desempata pelo menor percentual
        if (dataA.getTime() === dataB.getTime()) {
            return a.percentualAtual - b.percentualAtual;
        }
        return dataA - dataB;
    });

    // Itens SaudÃ¡veis
    const itensOk = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual > i.percentual_alerta
    ).length;

    // Itens que precisam de atenÃ§Ã£o (Todos abaixo do alerta)
    const contagemAtencao = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta
    ).length;

    // ==========================================
    // 2. CÃLCULOS DE SAÃšDE (PORCENTAGENS)
    // ==========================================
    const percAtencao = totalItens > 0 ? Math.round((contagemAtencao / totalItens) * 100) : 0;
    const percOk = totalItens > 0 ? Math.round((itensOk / totalItens) * 100) : 0;

    // ==========================================
    // 3. LÃ“GICA DE ÃšLTIMA COMPRA
    // ==========================================
    const todasAsDatas = data.estoque
        .map(i => i.data_ultima_compra)
        .filter(d => d !== null)
        .map(d => new Date(d + 'T00:00:00'));

    let diasDesdeUltimaCompra = "---";
    let itensUltimaCompra = 0;

    if (todasAsDatas.length > 0) {
        const ultimaDataObjeto = new Date(Math.max(...todasAsDatas));
        const hojeRef = new Date();
        hojeRef.setHours(0,0,0,0);
        
        const diffTempo = Math.abs(hojeRef - ultimaDataObjeto);
        diasDesdeUltimaCompra = Math.floor(diffTempo / (1000 * 60 * 60 * 24));

        const ultimaDataStr = ultimaDataObjeto.toISOString().split('T')[0];
        data.estoque.forEach(item => {
            const teveCompra = item.registros.some(r => r.data === ultimaDataStr && Number(r.comprada) > 0);
            if (teveCompra) itensUltimaCompra++;
        });
    }

    // ==========================================
    // 4. PREVISÃƒO DE DIAS E GASTOS (PRÃ“XIMA COMPRA)
    // ==========================================
    let textoDiasMercado = "Sem previsÃ£o";
    let gastoPrevisto = 0;

    const datasPrevisao = criticos
        .map(i => {
            if (!i.previsaoFim || i.previsaoFim === "Sem previsÃ£o") return null;
            const [dia, mes, ano] = i.previsaoFim.split('/');
            return new Date(`${ano}-${mes}-${dia}T00:00:00`);
        })
        .filter(d => d !== null);

    if (datasPrevisao.length > 0) {
        const dataMaisUrgente = new Date(Math.min(...datasPrevisao));
        const hojeCalc = new Date();
        hojeCalc.setHours(0,0,0,0);
        const diffMs = dataMaisUrgente - hojeCalc;
        const dias = Math.round(diffMs / (1000 * 60 * 60 * 24));

        if (dias > 1) textoDiasMercado = `Faltam ${dias} dias`;
        else if (dias === 1) textoDiasMercado = "Falta 1 dia";
        else if (dias === 0) textoDiasMercado = "Ã‰ hoje!";
        else textoDiasMercado = "Atrasado";
    }

    criticos.forEach(item => {
        const compras = item.registros.filter(r => Number(r.comprada) > 0 && Number(r.preco) > 0);
        const precoMedio = compras.length > 0 
            ? compras.reduce((acc, cur) => acc + Number(cur.preco), 0) / compras.length 
            : 0;
        
        const faltaParaIdeal = Math.max(0, item.quantidade_ideal - item.estoqueEstimado);
        gastoPrevisto += (faltaParaIdeal * precoMedio);
    });

    let todasAsDatasRegistros = [];
    data.estoque.forEach(item => {
        item.registros.forEach(reg => {
            todasAsDatasRegistros.push(reg.data);
        });
    });

    const datasUnicas = [...new Set(todasAsDatasRegistros)]
        .sort((a, b) => new Date(b) - new Date(a))
        .slice(0, 2);

    let eventosRecentes = [];
    data.estoque.forEach(item => {
        item.registros.forEach(reg => {
            if (datasUnicas.includes(reg.data)) {
                eventosRecentes.push({
                    nome: item.nome,
                    unidade: item.unidade_medida,
                    data: reg.data,
                    comprada: Number(reg.comprada),
                    encontrada: Number(reg.encontrada)
                });
            }
        });
    });

    eventosRecentes.sort((a, b) => new Date(b.data) - new Date(a.data));

    let ultimaDataCompra = null;
    if (todasAsDatas.length > 0) {
        ultimaDataCompra = new Date(Math.max(...todasAsDatas)).toISOString().split('T')[0];
    }

    let itensDaUltimaCompra = [];
    let valorTotalGeral = 0;

    if (ultimaDataCompra) {
        data.estoque.forEach(item => {
            const registroCompra = item.registros.find(r => r.data === ultimaDataCompra && Number(r.comprada) > 0);
            if (registroCompra) {
                const qtd = Number(registroCompra.comprada);
                const precoUnit = Number(registroCompra.preco || 0);
                const subtotal = qtd * precoUnit;
                valorTotalGeral += subtotal;
                itensDaUltimaCompra.push({
                    nome: item.nome,
                    categoria: item.categoria,
                    quantidade: qtd,
                    unidade: item.unidade_medida,
                    valorTotalItem: subtotal
                });
            }
        });
    }

    let dataTitulo = "Nenhuma compra";
    if (ultimaDataCompra) {
        const [ano, mes, dia] = ultimaDataCompra.split('-');
        dataTitulo = `${dia}/${mes}/${ano}`;
    }

    const listaSugestaoCompra = criticos.sort((a, b) => a.percentualAtual - b.percentualAtual);
%>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Â¡Listo!</title>
  <meta name="description" content="3D Glassmorphism Dashboard Template by TemplateMo">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <%- include('external/addons'); %>
  <!--

TemplateMo 607 Glass Admin

https://templatemo.com/tm-607-glass-admin

-->
</head>

<body>
  <!-- Animated Background -->
  <div class="background"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">Â¡L!</div>
        <span class="logo-text">Listo</span>
      </div>

      <ul class="nav-menu">
        <li class="nav-section">
          <span class="nav-section-title">NavegaÃ§Ã£o</span>
          <ul>
            <li class="nav-item">
              <a href="/" class="nav-link active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7" rx="1" />
                  <rect x="14" y="3" width="7" height="7" rx="1" />
                  <rect x="3" y="14" width="7" height="7" rx="1" />
                  <rect x="14" y="14" width="7" height="7" rx="1" />
                </svg>
                Painel de controle
              </a>
            </li>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z" />
                  <path d="M2 17l10 5 10-5" />
                  <path d="M2 12l10 5 10-5" />
                </svg>
                Todo o estoque
              </a>
            </li>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2v4M12 18v4M4 12H2M22 12h-2M18.364 5.636l-2.828 2.828M8.464 15.536l-2.828 2.828M18.364 18.364l-2.828-2.828M8.464 8.464L5.636 5.636" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                Inciar assistente
              </a>
            </li>
          </ul>
        </li>

        <li class="nav-section">
          <span class="nav-section-title">Conta</span>
          <ul>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                  <polyline points="16 17 21 12 16 7" />
                  <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                Sair
              </a>
            </li>
          </ul>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar"><%= data.dados_usuario.nome.charAt(0).toUpperCase() %></div>
          <div class="user-info">
            <div class="user-name"><%= data.dados_usuario.nome%></div>
            <div class="user-role">Administrador</div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navbar -->
      <nav class="navbar">
        <h1 class="page-title">Minha casa</h1>
        <div class="navbar-right">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" class="search-input" placeholder="Arroz Integral">
          </div>
          <button class="nav-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
              <path d="M13.73 21a2 2 0 0 1-3.46 0" />
            </svg>
            <span class="notification-dot"></span>
          </button>
          <button class="nav-btn" id="theme-toggle" title="Toggle Light/Dark Mode">
            <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4" />
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="M4.93 4.93l1.41 1.41" />
              <path d="M17.66 17.66l1.41 1.41" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="M6.34 17.66l-1.41 1.41" />
              <path d="M19.07 4.93l-1.41 1.41" />
            </svg>
            <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        </div>
      </nav>

      <!-- Stats Cards -->
      <section class="stats-grid">

        <div class="glass-card glass-card-3d stat-card">
          <div class="stat-card-inner">
            <div class="stat-info">
              <h3>Itens que precisam atenÃ§Ã£o</h3>
              <div class="stat-value"><%= contagemAtencao %></div>
              <span class="stat-change <%= percAtencao > 40 ? 'negative' : 'positive' %>">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                </svg>
                <%= percAtencao %>% do total de itens
              </span>
            </div>
            <div class="stat-icon cyan">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
              </svg>
            </div>
          </div>
        </div>

        <div class="glass-card glass-card-3d stat-card">
          <div class="stat-card-inner">
            <div class="stat-info">
              <h3>Itens sob controle</h3>
              <div class="stat-value"><%= itensOk %></div>
              <span class="stat-change positive">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                </svg>
                <%= percOk %>% de saÃºde global
              </span>
            </div>
            <div class="stat-icon magenta">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                <polyline points="20 6 9 17 4 12" />
              </svg>
            </div>
          </div>
        </div>

        <div class="glass-card glass-card-3d stat-card">
          <div class="stat-card-inner">
            <div class="stat-info">
              <h3>Dias desde a Ãºltima compra</h3>
              <div class="stat-value"><%= diasDesdeUltimaCompra %></div>
              <span class="stat-change positive">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" />
                  <line x1="3" y1="6" x2="21" y2="6" />
                  <path d="M16 10a4 4 0 0 1-8 0" />
                </svg>
                <%= itensUltimaCompra %> itens repostos
              </span>
            </div>
            <div class="stat-icon purple">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--coral)" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <line x1="16" y1="2" x2="16" y2="6" />
                <line x1="8" y1="2" x2="8" y2="6" />
                <line x1="3" y1="10" x2="21" y2="10" />
              </svg>
            </div>
          </div>
        </div>

        <div class="glass-card glass-card-3d stat-card">
          <div class="stat-card-inner">
            <div class="stat-info">
              <h3>Dias atÃ© prÃ³xima compra</h3>
              <div class="stat-value"><%= textoDiasMercado %></div>
              <span class="stat-change pending">
                Gasto estimado: R$ <%= gastoPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
              </span>
            </div>
            <div class="stat-icon success">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--emerald)" stroke-width="2">
                <circle cx="9" cy="21" r="1" />
                <circle cx="20" cy="21" r="1" />
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
              </svg>
            </div>
          </div>
        </div>
      </section>

      <!-- Content Grid -->
      <section class="content-grid">


        <!-- Activity Feed -->
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">CrÃ­ticos</h2>
              <p class="card-subtitle">Prioridade por data de tÃ©rmino</p>
            </div>
          </div>
          <div class="activity-list">

            <% if (criticos.length === 0) { %>
            <p style="text-align:center; color: var(--text-dim); padding: 20px; font-size: 0.9rem;">
              Tudo sob controle por aqui! ðŸŽ‰
            </p>
            <% } %>

            <% 
      // FUNÃ‡ÃƒO DE ORDENAÃ‡ÃƒO ROBUSTA
      const criticosOrdenados = criticos.sort((a, b) => {
          const parseData = (item) => {
              if (item.previsaoFim === 'Hoje') return new Date();
              if (item.previsaoFim === 'Atrasado') return new Date(0); // Joga pro topo absoluto
              if (!item.previsaoFim || item.previsaoFim === 'Sem previsÃ£o') return new Date(8640000000000000);
              
              const partes = item.previsaoFim.split('/');
              return new Date(partes[2], partes[1] - 1, partes[0]);
          };

          const dataA = parseData(a);
          const dataB = parseData(b);

          // Primeiro ordena por data
          if (dataA.getTime() !== dataB.getTime()) {
              return dataA - dataB;
          }
          // Se for a mesma data, o que tem MENOS estoque (percentual) sobe
          return a.percentualAtual - b.percentualAtual;
      });

      criticosOrdenados.forEach(item => { 
        // LÃ³gica de Ã­cones (mantida conforme seu padrÃ£o)
        let svgIcon = '';
        let gradient = '';
        switch(item.categoria) {
            case 'Higiene':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>';
                gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)';
                break;
            case 'Alimentos':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>';
                gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)';
                break;
            case 'Limpeza':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>';
                gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)';
                break;
            default:
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>';
                gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
        }

        let dataCompraStr = 'N/A';
        if (item.data_ultima_compra) {
            const [ano, mes, dia] = item.data_ultima_compra.split('-');
            dataCompraStr = `${dia}/${mes}/${ano}`;
        }

        const isMuitoCritico = item.percentualAtual <= 10 || item.previsaoFim === 'Hoje' || item.previsaoFim === 'Atrasado';
    %>

            <div class="activity-item">
              <div class="activity-avatar" style="--bg-icon: <%= gradient %>; background: var(--bg-icon); color: white; display: flex; align-items: center; justify-content: center; padding: 8px; position: relative;">
                <%- svgIcon %>
                <% if (isMuitoCritico) { %>
                <span style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff5e62; border-radius: 50%; border: 1px solid white;"></span>
                <% } %>
              </div>
              <div class="activity-content">
                <p class="activity-text">
                  <strong><%= item.nome %></strong> acabarÃ¡ em <span class="<%= isMuitoCritico ? 'text-danger' : '' %>" style="font-weight: 600;"><%= item.previsaoFim %></span>
                </p>
                <span class="activity-time">
                  <%= item.estoqueEstimado %> de <%= item.quantidade_ideal %> <%= item.unidade_medida %>. Ãšltima compra: <%= dataCompraStr %> (<%= item.percentualAtual %>%)
                </span>
              </div>
            </div>

            <% }) %>

          </div>
        </div>
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Ãšltimas atualizaÃ§Ãµes</h2>
              <p class="card-subtitle">HistÃ³rico das Ãºltimas duas datas de registro</p>
            </div>
          </div>
          <div class="activity-list">

            <% if (eventosRecentes.length === 0) { %>
            <p style="text-align:center; color: var(--text-dim); padding: 20px;">Nenhuma atividade recente.</p>
            <% } %>

            <% eventosRecentes.forEach(evento => { 
        const [ano, mes, dia] = evento.data.split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;
        
        // Define se foi uma COMPRA ou apenas ATUALIZAÃ‡ÃƒO DE ESTOQUE
        const ehCompra = evento.comprada > 0;
    %>
            <div class="activity-item">
              <div class="activity-avatar" style="background: <%= ehCompra ? 'linear-gradient(135deg, #43e97b, #38f9d7)' : 'linear-gradient(135deg, #3a7bd5, #00d2ff)' %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
                <% if (ehCompra) { %>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <% } else { %>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 11a8.1 8.1 0 0 0-15.5-2m-.5-4v4h4"></path>
                  <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                </svg>
                <% } %>
              </div>
              <div class="activity-content">
                <p class="activity-text">
                  <strong><%= ehCompra ? 'Compra efetuada' : 'Estoque atualizado' %></strong>:
                  <%= ehCompra ? evento.comprada : evento.encontrada %> <%= evento.unidade %> de <%= evento.nome %>
                </p>
                <span class="activity-time"><%= dataFormatada %></span>
              </div>
            </div>
            <% }) %>

          </div>
        </div>

        <!-- Data Table -->
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Ãšltima compra (<%= dataTitulo %>)</h2>
              <p class="card-subtitle">
                Valor total: <strong>R$ <%= valorTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></strong>
              </p>
            </div>
          </div>
          <div class="activity-list">

            <% if (itensDaUltimaCompra.length === 0) { %>
            <p style="text-align:center; color: var(--text-dim); padding: 20px;">Nenhum item registrado nesta data.</p>
            <% } %>

            <% itensDaUltimaCompra.forEach(item => { 
            // Reaproveitando a lÃ³gica de Ã­cones por categoria
            let svgIcon = '';
            let gradient = '';
            switch(item.categoria) {
            case 'Higiene':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>';
                gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)';
                break;
            case 'Alimentos':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>';
                gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)';
                break;
            case 'Limpeza':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>';
                gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)';
                break;
            default:
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>';
                gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
        %>
            <div class="activity-item">
              <div class="activity-avatar" style="background: <%= gradient %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
                <%- svgIcon %>
              </div>
              <div class="activity-content">
                <p class="activity-text">
                  <strong><%= item.nome %></strong>. <%= item.quantidade %> <%= item.unidade %>.
                </p>
                <span class="activity-time">
                  Subtotal: R$ <%= item.valorTotalItem.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                </span>
              </div>
            </div>
            <% }) %>

          </div>
        </div>
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">PrÃ³xima compra (Estimativa)</h2>
              <p class="card-subtitle">
                Gasto previsto: <strong>R$ <%= gastoPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></strong>
              </p>
            </div>
          </div>
          <div class="activity-list">

            <% if (listaSugestaoCompra.length === 0) { %>
            <p style="text-align:center; color: var(--text-dim); padding: 20px;">
              Nada para comprar no momento! ðŸ™Œ
            </p>
            <% } %>

            <% listaSugestaoCompra.forEach(item => { 
            // 2. Calcular quanto comprar para atingir o estoque ideal
            const quantoComprar = Math.max(0, item.quantidade_ideal - item.estoqueEstimado);
            
            // 3. Pegar o preÃ§o mÃ©dio para o subtotal estimado
            const comprasAnteriores = item.registros.filter(r => Number(r.comprada) > 0 && Number(r.preco) > 0);
            const precoMedio = comprasAnteriores.length > 0 
                ? comprasAnteriores.reduce((acc, cur) => acc + Number(cur.preco), 0) / comprasAnteriores.length 
                : 0;
            
            const subtotalEstimado = quantoComprar * precoMedio;

            // LÃ³gica de Ã­cones (reutilizada)
            let svgIcon = '';
            let gradient = '';
            switch(item.categoria) {
            case 'Higiene':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>';
                gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)';
                break;
            case 'Alimentos':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>';
                gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)';
                break;
            case 'Limpeza':
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>';
                gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)';
                break;
            default:
                svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>';
                gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
        %>
            <div class="activity-item">
              <div class="activity-avatar" style="background: <%= gradient %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
                <%- svgIcon %>
              </div>
              <div class="activity-content">
                <p class="activity-text">
                  <strong>Comprar <%= quantoComprar.toFixed(1).replace('.0', '') %> <%= item.unidade_medida %></strong> de <%= item.nome %>.
                </p>
                <span class="activity-time">
                  Estimado: R$ <%= subtotalEstimado.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>
                  (<%= item.percentualAtual %>% em estoque)
                </span>
              </div>
            </div>
            <% }) %>

          </div>
        </div>
      </section>

      <!-- Bottom Grid -->

    </main>
  </div>

  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12" />
      <line x1="3" y1="6" x2="21" y2="6" />
      <line x1="3" y1="18" x2="21" y2="18" />
    </svg>
  </button>

  <!-- Footer -->
  <footer class="site-footer">
    <p>Copyright Â© 2026 Dev: Mateus Kaufmann Â· UI: TemplateMo</p>
  </footer>
  <!-- TemplateMo 607 Glass Admin -->
</body>

</html>