<% 

data.estoque.forEach(i => {
        if(i.nome.toLowerCase().includes('inseticida')) {
            console.log('--- DEBUG INSETICIDA ---');
            console.log('Nome:', i.nome);
            console.log('Mensur√°vel:', i.consumo_mensuravel);
            console.log('Qtd Registros:', i.registros ? i.registros.length : '0');
            if(i.registros && i.registros.length > 0) {
               console.log('Data √öltimo Registro:', i.registros[i.registros.length - 1].data_registro);
            }
        }
    });


const criticos=data.estoque.filter(i=> i.percentualAtual !== null &&
    i.percentualAtual <= i.percentual_alerta && i.consumo_mensuravel===1); const itensOk=data.estoque.filter(i=>
        i.percentualAtual !== null &&
        i.percentualAtual > i.percentual_alerta
        ).length;

        const totalItens = data.estoque.length;


        // Pegamos todas as datas de √∫ltima compra, removemos as nulas e transformamos em objetos Date
    const todasAsDatas = data.estoque
        .map(i => i.data_ultima_compra)
        .filter(d => d !== null)
        .map(d => new Date(d + 'T00:00:00')); // T00:00:00 evita erros de fuso

    let diasDesdeUltimaCompra = "---";

    if (todasAsDatas.length > 0) {
        // Encontramos a data mais recente (a maior)
        const ultimaDataGeral = new Date(Math.max(...todasAsDatas));
        const hoje = new Date();
        
        // Calculamos a diferen√ßa em milissegundos e convertemos para dias
        const diffTempo = Math.abs(hoje - ultimaDataGeral);
        diasDesdeUltimaCompra = Math.floor(diffTempo / (1000 * 60 * 60 * 24));
    }

let proximaIdaMercado = "Sem previs√£o";
    
    // Filtramos apenas itens que possuem uma data de previs√£o v√°lida
    // (Lembrando que previsaoFim est√° no formato DD/MM/YYYY)
    const datasPrevisao = criticos
        .map(i => {
            if (!i.previsaoFim || i.previsaoFim === "Sem previs√£o") return null;
            const [dia, mes, ano] = i.previsaoFim.split('/');
            return new Date(`${ano}-${mes}-${dia}T00:00:00`);
        })
        .filter(d => d !== null);

    if (datasPrevisao.length > 0) {
        // Encontramos a data mais pr√≥xima (a menor de todas)
        const dataMaisUrgente = new Date(Math.min(...datasPrevisao));
        
        // Formatamos de volta para DD/MM
        const dia = String(dataMaisUrgente.getDate()).padStart(2, '0');
        const mes = String(dataMaisUrgente.getMonth() + 1).padStart(2, '0');
        proximaIdaMercado = `${dia}/${mes}`;
    }


    // Filtra todos os itens que est√£o abaixo do seu limite de alerta personalizado
    const listaAtencao = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta
    );

    // Esta √© a vari√°vel que vamos usar no card
    const contagemAtencao = listaAtencao.length;
//NOVO NOVO NOVO
   const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    const itensInativos = data.estoque.filter(item => {
        // 1. Apenas consumo irregular
        if (Number(item.consumo_mensuravel) !== 0) return false;

        // 2. Se n√£o tem registros, precisa revisar
        if (!item.registros || item.registros.length === 0) return true;

        // 3. Pega a data usando o nome correto: 'data'
        const ultimoMov = item.registros[item.registros.length - 1].data;
        if (!ultimoMov) return true;

        const dataRef = new Date(ultimoMov + 'T12:00:00');
        dataRef.setHours(0, 0, 0, 0);

        const diffDias = Math.floor((hoje - dataRef) / (1000 * 60 * 60 * 24));
        
        return diffDias >= 14;
   
    }); // Fechamento do filter
   
        %>
        <!DOCTYPE html>
        <html lang="en">

        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Listo - Dashboard</title>
            <script>
                // Prevent flash of white in dark mode - runs before CSS/page render
                if (localStorage.getItem('daynight-theme') === 'carbon') {
                    document.documentElement.classList.add('carbon');
                }
            </script>
            <%- include('external/addons'); %>
                <!--

TemplateMo 608 DayNight Admin

https://templatemo.com/tm-608-daynight-admin

-->
        </head>

        <body>
            <!-- Mobile Menu Overlay -->
            <div class="mobile-menu-overlay"></div>

            <!-- Mobile Menu -->
            <div class="mobile-menu">
                <div class="mobile-menu-header">
                    <a href="index.html" class="logo">
                        <div class="logo-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                        </div>
                        ¬°Listo!
                    </a>
                    <button class="mobile-menu-close" onclick="closeMobileMenu()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <nav class="mobile-menu-nav">
                    <div class="nav-item">
                                    <a href="index.html" class="nav-link active">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="7" height="7" rx="1" />
                                            <rect x="14" y="3" width="7" height="7" rx="1" />
                                            <rect x="3" y="14" width="7" height="7" rx="1" />
                                            <rect x="14" y="14" width="7" height="7" rx="1" />
                                        </svg>
                                        Dashboard
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="projects.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                        </svg>
                                        Meus itens
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="analytics.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="20" x2="18" y2="10" />
                                            <line x1="12" y1="20" x2="12" y2="4" />
                                            <line x1="6" y1="20" x2="6" y2="14" />
                                        </svg>
                                        Iniciar Assistente
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="analytics.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="9" cy="21" r="1"></circle>
    <circle cx="20" cy="21" r="1"></circle>
    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
</svg>
                                        Estou no mercado
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="settings.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3" />
                                            <path
                                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                                        </svg>
                                        Configura√ß√µes
                                    </a>
                                </div>
                </nav>
                <div class="mobile-menu-footer">
                    <a href="login.html" class="mobile-logout-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        Logout
                    </a>
                    <div class="theme-toggle">
                        <button class="theme-btn theme-btn-snow active" onclick="setTheme('snow')" title="Snow Edition">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5" />
                                <line x1="12" y1="1" x2="12" y2="3" />
                                <line x1="12" y1="21" x2="12" y2="23" />
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                                <line x1="1" y1="12" x2="3" y2="12" />
                                <line x1="21" y1="12" x2="23" y2="12" />
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                            </svg>
                        </button>
                        <button class="theme-btn theme-btn-carbon" onclick="setTheme('carbon')" title="Carbon Edition">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="app-container">
                <!-- Top Navigation -->
                <nav class="top-nav">
                    <div class="nav-container">
                        <div class="nav-left">
                            <a href="index.html" class="logo">
                                <div class="logo-icon">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path
                                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                    </svg>
                                </div>
                                ¬°Listo!
                            </a>
                            <div class="nav-menu">
                                <div class="nav-item">
                                    <a href="index.html" class="nav-link active">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="7" height="7" rx="1" />
                                            <rect x="14" y="3" width="7" height="7" rx="1" />
                                            <rect x="3" y="14" width="7" height="7" rx="1" />
                                            <rect x="14" y="14" width="7" height="7" rx="1" />
                                        </svg>
                                        Dashboard
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="projects.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path
                                                d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                                        </svg>
                                        Meus itens
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="analytics.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="20" x2="18" y2="10" />
                                            <line x1="12" y1="20" x2="12" y2="4" />
                                            <line x1="6" y1="20" x2="6" y2="14" />
                                        </svg>
                                        Iniciar Assistente
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="analytics.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="9" cy="21" r="1"></circle>
    <circle cx="20" cy="21" r="1"></circle>
    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
</svg>
                                        Estou no mercado
                                    </a>
                                </div>
                                <div class="nav-item">
                                    <a href="settings.html" class="nav-link">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3" />
                                            <path
                                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                                        </svg>
                                        Configura√ß√µes
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="nav-right">
                            <div class="theme-toggle">
                            </div>
                            <button class="user-menu">
                                <div class="user-avatar">:)</div>
                                <span class="user-name">
                                    <%= data.dados_usuario.nome%>
                                </span>
                            </button>
                            <a href="login.html" class="btn-logout" title="Logout">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                    <polyline points="16 17 21 12 16 7" />
                                    <line x1="21" y1="12" x2="9" y2="12" />
                                </svg>
                            </a>
                            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="3" y1="12" x2="21" y2="12" />
                                    <line x1="3" y1="6" x2="21" y2="6" />
                                    <line x1="3" y1="18" x2="21" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </nav>

                <!-- Main Content -->
                <main class="main-content">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1 class="greeting" id="greeting">Ol√°, <%= data.dados_usuario.nome%>!</h1>
                        <p class="greeting-sub">Aqui est√° o relat√≥rio de sua casa.</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Itens que precisam de aten√ß√£o</div>
                            <div class="stat-value"><%= contagemAtencao %></div>

                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Itens regulares</div>
                            <div class="stat-value">
                                <%= itensOk %>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Dias desde a √∫ltima compra</div>
                            <div class="stat-value"><%= diasDesdeUltimaCompra %></div>

                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pr√≥xima ida ao mercado em</div>
                            <div class="stat-value"><%= proximaIdaMercado %></div>

                        </div>
                    </div>

                    <!-- Two Column Layout -->
                    <div class="two-col">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title text-danger">Alerta cr√≠tico</h3>
                                <p class="card-subtitle">Itens consum√≠veis com t√©rmino pr√≥ximo</p>
                            </div>

                            <div class="card-scroll">
                                <div class="activity-feed">

                                    <% if (criticos.length===0) { %>
                                        <p style="text-align:center; color:#6c757d; padding: 20px;">
                                            Tudo sob controle por aqui! üéâ
                                        </p>
                                        <% } %>

                                            <% /* Note que aqui n√£o usamos mais 'const criticos = ...' , apenas o
                                                forEach direto */ %>
                                                <% criticos.forEach(item=> {
                                                    /* 1. L√≥gica do √≠cone (mantemos aqui dentro porque muda para cada
                                                    item)*/
                                                    let svgIcon = '';
                                                    switch(item.categoria) {
                case 'Higiene':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12 20.73 6.96" /><line x1="12" y1="22" x2="12" y2="12" /></svg>';
                    break;
                case 'Alimentos':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /><path d="M9 4c1 1 2 2 3 3" /></svg>';
                    break;
                case 'Limpeza':
                    svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6" /><path d="M10 3v4" /><path d="M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /><path d="M16 5l3 2" /></svg>';
                    break;
                default:
                    svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>';
            }

                                                    // 2. Tratamento da data da √∫ltima compra (que vem do seu novo DAO)
                                                    let dataCompraStr = 'N/A';
                                                    if (item.data_ultima_compra) {
                                                    const [ano, mes, dia] = item.data_ultima_compra.split('-');
                                                    dataCompraStr = `${dia}/${mes}/${ano}`;
                                                    }

                                                    const iconColor = item.percentualAtual <= 10 ? 'red' : 'blue' ; %>
                                                        <div class="activity-item">
                                                            <div class="activity-icon <%= iconColor %>">
                                                                <%- svgIcon %>
                                                            </div>
                                                            <div class="activity-content">
                                                                <p class="activity-text">
                                                                    <strong>
                                                                        <%= item.nome %>
                                                                    </strong> pode estar acabando!
                                                                    (<%= item.estoqueEstimado %>
                                                                        <%= item.unidade_medida %> de <%=
                                                                                item.quantidade_ideal %>
                                                                                <%= item.unidade_medida %>)
                                                                </p>
                                                                <span class="activity-time">
                                                                    Previs√£o de t√©rmino <strong>
                                                                        <%= item.previsaoFim %>
                                                                    </strong>.
                                                                    √öltima compra em <strong>
                                                                        <%= dataCompraStr %>
                                                                    </strong>
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <% }) %>

                                </div>
                            </div>
                        </div>
                        <div class="card">
    <div class="card-header">
        <h3 class="card-title text-warning">A revisar</h3>
        <p class="card-subtitle">Itens de consumo irregular abaixo do ideal</p>
    </div>

    <div class="card-scroll">
        <div class="activity-feed">
            <% 
                // Filtramos aqui apenas os itens que N√ÉO s√£o mensur√°veis e est√£o abaixo do alerta
                const irregulares = data.estoque.filter(i => 
                    i.percentualAtual <= i.percentual_alerta && 
                    i.consumo_mensuravel === 0
                );
            %>

            <% if (irregulares.length === 0) { %>
                <p style="text-align:center; color:#6c757d; padding: 20px;">
                    Nenhum item irregular precisando de aten√ß√£o! ‚ú®
                </p>
            <% } %>

            <% irregulares.forEach(item => { 
                // L√≥gica de √≠cone id√™ntica para manter o padr√£o
                let svgIcon = '';
                switch(item.categoria) {
                    case 'Higiene':
                        svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12 20.73 6.96" /><line x1="12" y1="22" x2="12" y2="12" /></svg>';
                        break;
                    case 'Alimentos':
                        svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /><path d="M9 4c1 1 2 2 3 3" /></svg>';
                        break;
                    case 'Limpeza':
                        svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6" /><path d="M10 3v4" /><path d="M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /><path d="M16 5l3 2" /></svg>';
                        break;
                    default:
                        svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>';
                }

                // Cores por categoria conforme combinamos
                let iconColor = 'blue';
                switch(item.categoria) {
                    case 'Alimentos': iconColor = 'yellow'; break;
                    case 'Limpeza': iconColor = 'green'; break;
                    case 'Higiene': iconColor = 'pink'; break;
                }

                let dataCompraStr = item.data_ultima_compra ? item.data_ultima_compra.split('-').reverse().join('/') : 'N/A';
            %>
                <div class="activity-item">
                    <div class="activity-icon <%= iconColor %>">
                        <%- svgIcon %>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">
                            <strong><%= item.nome %></strong> est√° abaixo do ideal! 
                            (<%= item.percentualAtual %>% em estoque)
                        </p>
                        <span class="activity-time">
                            Consumo irregular (sem previs√£o). 
                            √öltima compra em <strong><%= dataCompraStr %></strong>
                        </span>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</div>
                    </div>
<div class="two-col" style="margin-top: 1.5rem;">                        <div class="card">
    <div class="card-header">
        <h3 class="card-title text-warning">A revisar (Inativos)</h3>
        <p class="card-subtitle">Itens sem atualiza√ß√£o h√° +14 dias</p>
    </div>

    <div class="card-scroll">
        <div class="activity-feed">
            <% if (itensInativos.length === 0) { %>
                <p style="text-align:center; color:#6c757d; padding: 20px;">
                    Todos os itens foram conferidos recentemente! üëç
                </p>
            <% } %>

            <% itensInativos.forEach(item => { 
                // 1. Busca a data com seguran√ßa
                let dataExibicao = 'Nunca revisado';
                
                if (item.registros && item.registros.length > 0) {
                    const ultimaData = item.registros[item.registros.length - 1].data_registro;
                    if (ultimaData) {
                        dataExibicao = ultimaData.split('-').reverse().join('/');
                    }
                }

                // 2. Cores das categorias (mantendo o seu padr√£o)
                let iconColor = 'blue';
                switch(item.categoria) {
                    case 'Alimentos': iconColor = 'yellow'; break;
                    case 'Limpeza': iconColor = 'green'; break;
                    case 'Higiene': iconColor = 'pink'; break;
                }
            %>
                <div class="activity-item">
                    <div class="activity-icon <%= iconColor %>">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div class="activity-content">
                        <p class="activity-text">
                            <strong><%= item.nome %></strong> precisa de confer√™ncia.
                        </p>
                        <span class="activity-time">
                            √öltima atualiza√ß√£o em: <strong><%= dataExibicao %></strong><br>
                            Status atual: <strong><%= item.percentualAtual %>%</strong> em estoque.
                        </span>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</div>
                        
                    </div>









            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title text-warning">Aten√ß√£o</h3>
                        <p class="card-subtitle">Estes itens est√£o perto de atingir o limite.</p>
                    </div>
                    <button class="btn btn-ghost"></button>
                </div>
                <div class="card-scroll">
                    <div class="card-scroll-inner" style="min-width: 360px;">
                        <div class="activity-feed">
                            <div class="activity-item">
                                <div class="activity-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                        <polyline points="14 2 14 8 20 8" />
                                        <line x1="16" y1="13" x2="8" y2="13" />
                                        <line x1="16" y1="17" x2="8" y2="17" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>Arroz Branco</strong> est√° perto de
                                        acabar
                                        (35%)</p>
                                    <span class="activity-time">Previs√£o de dura√ß√£o at√© 00/00/000</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                        <polyline points="22 4 12 14.01 9 11.01" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>Michael Torres</strong> completed task
                                        "API
                                        Integration"</p>
                                    <span class="activity-time">15 minutes ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon orange">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>Emma Wilson</strong> commented on your
                                        project
                                        proposal</p>
                                    <span class="activity-time">1 hour ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                        <circle cx="8.5" cy="7" r="4" />
                                        <line x1="20" y1="8" x2="20" y2="14" />
                                        <line x1="23" y1="11" x2="17" y2="11" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>James Lee</strong> joined the team as
                                        Frontend
                                        Developer</p>
                                    <span class="activity-time">3 hours ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text">Scheduled deployment for
                                        <strong>v2.4.0</strong>
                                        completed successfully
                                    </p>
                                    <span class="activity-time">5 hours ago</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Comparison Chart -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Idas ao mercado, por m√™s</h3>
                        <p class="card-subtitle">Frequ√™ncia de compras</p>
                    </div>
                    <div class="date-picker">
                        <button class="date-btn" onclick="setDateRange('7d', this)">7D</button>
                        <button class="date-btn active" onclick="setDateRange('30d', this)">30D</button>
                        <button class="date-btn" onclick="setDateRange('90d', this)">90D</button>
                        <button class="date-btn" onclick="setDateRange('12m', this)">12M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-scroll">
                        <div class="chart-scroll-inner">
                            <div class="bar-chart">
                                <div class="y-axis">
                                    <span class="y-axis-label">R$6K</span>
                                    <span class="y-axis-label">R$5K</span>
                                    <span class="y-axis-label">R$4K</span>
                                    <span class="y-axis-label">R$3K</span>
                                    <span class="y-axis-label">R$2K</span>
                                    <span class="y-axis-label">R$1K</span>
                                </div>
                                <div class="y-axis-lines">
                                    <div class="y-axis-line"></div>
                                    <div class="y-axis-line"></div>
                                    <div class="y-axis-line"></div>
                                    <div class="y-axis-line"></div>
                                    <div class="y-axis-line"></div>
                                    <div class="y-axis-line"></div>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 80px;"></div>
                                        <div class="bar current" style="height: 100px;"></div>
                                    </div>
                                    <span class="bar-label">Jan</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 95px;"></div>
                                        <div class="bar current" style="height: 120px;"></div>
                                    </div>
                                    <span class="bar-label">Feb</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 70px;"></div>
                                        <div class="bar current" style="height: 85px;"></div>
                                    </div>
                                    <span class="bar-label">Mar</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 110px;"></div>
                                        <div class="bar current" style="height: 140px;"></div>
                                    </div>
                                    <span class="bar-label">Apr</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 90px;"></div>
                                        <div class="bar current" style="height: 105px;"></div>
                                    </div>
                                    <span class="bar-label">May</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 130px;"></div>
                                        <div class="bar current" style="height: 155px;"></div>
                                    </div>
                                    <span class="bar-label">Jun</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 100px;"></div>
                                        <div class="bar current" style="height: 125px;"></div>
                                    </div>
                                    <span class="bar-label">Jul</span>
                                </div>
                                <div class="bar-group">
                                    <div class="bar-wrapper">
                                        <div class="bar previous" style="height: 85px;"></div>
                                        <div class="bar current" style="height: 110px;"></div>
                                    </div>
                                    <span class="bar-label">Aug</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <span class="legend-dot current"></span>
                            This Period
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot previous"></span>
                            Previous Period
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Recent Activity</h3>
                        <p class="card-subtitle">Latest updates from your team</p>
                    </div>
                    <button class="btn btn-ghost">View All</button>
                </div>
                <div class="card-scroll">
                    <div class="card-scroll-inner" style="min-width: 360px;">
                        <div class="activity-feed">
                            <div class="activity-item">
                                <div class="activity-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                        <polyline points="14 2 14 8 20 8" />
                                        <line x1="16" y1="13" x2="8" y2="13" />
                                        <line x1="16" y1="17" x2="8" y2="17" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>Arroz Branco</strong> pode estar acabando! (1kg de
                                        5kg)</p>
                                    <span class="activity-time">Previs√£o de t√©rmino 00/00/0000. √πltima compra em
                                        00/00/0000</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                                        <polyline points="22 4 12 14.01 9 11.01" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>Michael Torres</strong> completed task
                                        "API
                                        Integration"</p>
                                    <span class="activity-time">15 minutes ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon orange">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>Emma Wilson</strong> commented on your
                                        project
                                        proposal</p>
                                    <span class="activity-time">1 hour ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon blue">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                        <circle cx="8.5" cy="7" r="4" />
                                        <line x1="20" y1="8" x2="20" y2="14" />
                                        <line x1="23" y1="11" x2="17" y2="11" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text"><strong>James Lee</strong> joined the team as
                                        Frontend
                                        Developer</p>
                                    <span class="activity-time">3 hours ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon green">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text">Scheduled deployment for
                                        <strong>v2.4.0</strong>
                                        completed successfully
                                    </p>
                                    <span class="activity-time">5 hours ago</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Additional Chart Row -->
            <div class="two-col" style="margin-top: 1.5rem;">
                <!-- User Growth Chart -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">User Growth</h3>
                            <p class="card-subtitle">New users vs returning users</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-scroll">
                            <div class="chart-scroll-inner">
                                <div class="bar-chart">
                                    <div class="y-axis">
                                        <span class="y-axis-label">500</span>
                                        <span class="y-axis-label">400</span>
                                        <span class="y-axis-label">300</span>
                                        <span class="y-axis-label">200</span>
                                        <span class="y-axis-label">100</span>
                                        <span class="y-axis-label">0</span>
                                    </div>
                                    <div class="y-axis-lines">
                                        <div class="y-axis-line"></div>
                                        <div class="y-axis-line"></div>
                                        <div class="y-axis-line"></div>
                                        <div class="y-axis-line"></div>
                                        <div class="y-axis-line"></div>
                                        <div class="y-axis-line"></div>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 70px; background: var(--success);"></div>
                                            <div class="bar" style="height: 90px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 1</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 85px; background: var(--success);"></div>
                                            <div class="bar" style="height: 100px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 2</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 95px; background: var(--success);"></div>
                                            <div class="bar" style="height: 115px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 3</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 110px; background: var(--success);"></div>
                                            <div class="bar" style="height: 130px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 4</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 100px; background: var(--success);"></div>
                                            <div class="bar" style="height: 125px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 5</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 120px; background: var(--success);"></div>
                                            <div class="bar" style="height: 145px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 6</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 130px; background: var(--success);"></div>
                                            <div class="bar" style="height: 155px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 7</span>
                                    </div>
                                    <div class="bar-group">
                                        <div class="bar-wrapper">
                                            <div class="bar" style="height: 140px; background: var(--success);"></div>
                                            <div class="bar" style="height: 160px; background: #A855F7;"></div>
                                        </div>
                                        <span class="bar-label">Week 8</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <span class="legend-dot" style="background: var(--success);"></span>
                                New Users
                            </div>
                            <div class="legend-item">
                                <span class="legend-dot" style="background: #A855F7;"></span>
                                Returning Users
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Performance Metrics</h3>
                            <p class="card-subtitle">Key performance indicators</p>
                        </div>
                    </div>
                    <div class="card-scroll">
                        <div class="card-scroll-inner" style="min-width: 400px;">
                            <div style="padding: 0.5rem 0;">
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: var(--text-primary);">Customer
                                            Satisfaction</span>
                                        <span
                                            style="font-size: 0.875rem; font-weight: 600; color: var(--success);">92%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill success" style="width: 92%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: var(--text-primary);">Response
                                            Time</span>
                                        <span
                                            style="font-size: 0.875rem; font-weight: 600; color: var(--accent);">78%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill accent" style="width: 78%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: var(--text-primary);">Task
                                            Completion</span>
                                        <span
                                            style="font-size: 0.875rem; font-weight: 600; color: var(--success);">85%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill success" style="width: 85%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: var(--text-primary);">System
                                            Uptime</span>
                                        <span
                                            style="font-size: 0.875rem; font-weight: 600; color: var(--success);">99.9%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill success" style="width: 99.9%;"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: var(--text-primary);">Bug
                                            Resolution</span>
                                        <span
                                            style="font-size: 0.875rem; font-weight: 600; color: var(--warning);">68%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill warning" style="width: 68%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </main>

            <!-- Footer -->
            <footer class="footer">
                <p>&copy; 2026 DayNight Admin. Designed by <a href="https://www.templatemo.com" target="_blank"
                        rel="nofollow">TemplateMo</a></p>
            </footer>
            </div>

            <script src="templatemo-daynight-script.js"></script>
        </body>

        </html>