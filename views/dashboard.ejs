<% 
    // ==========================================
    // 1. FILTROS E CONTAGENS B√ÅSICAS
    // ==========================================
    const totalItens = data.estoque.length;
    
    // Itens Cr√≠ticos (Abaixo do alerta e mensur√°veis)
    const criticosRaw = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta && 
        i.consumo_mensuravel === 1
    );

    // ORDENA√á√ÉO POR T√âRMINO (O que acaba antes no topo)
    const criticos = criticosRaw.sort((a, b) => {
        const converterData = (dataStr) => {
            if (!dataStr || dataStr === 'N/A' || dataStr === 'Sem previs√£o') return new Date(8640000000000000);
            const [dia, mes, ano] = dataStr.split('/');
            return new Date(ano, mes - 1, dia);
        };
        const dataA = converterData(a.previsaoFim);
        const dataB = converterData(b.previsaoFim);
        
        // Se as datas forem iguais, desempata pelo menor percentual
        if (dataA.getTime() === dataB.getTime()) {
            return a.percentualAtual - b.percentualAtual;
        }
        return dataA - dataB;
    });

    // Itens Saud√°veis
    const itensOk = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual > i.percentual_alerta
    ).length;

    // Itens que precisam de aten√ß√£o (Todos abaixo do alerta)
    const contagemAtencao = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta
    ).length;

    // ==========================================
    // 2. C√ÅLCULOS DE SA√öDE (PORCENTAGENS)
    // ==========================================
    const percAtencao = totalItens > 0 ? Math.round((contagemAtencao / totalItens) * 100) : 0;
    const percOk = totalItens > 0 ? Math.round((itensOk / totalItens) * 100) : 0;

    // ==========================================
    // 3. L√ìGICA DE √öLTIMA COMPRA
    // ==========================================
    const todasAsDatas = data.estoque
        .map(i => i.data_ultima_compra)
        .filter(d => d !== null)
        .map(d => new Date(d + 'T00:00:00'));

    let diasDesdeUltimaCompra = "---";
    let itensUltimaCompra = 0;

    if (todasAsDatas.length > 0) {
        const ultimaDataObjeto = new Date(Math.max(...todasAsDatas));
        const hojeRef = new Date();
        hojeRef.setHours(0,0,0,0);
        
        const diffTempo = Math.abs(hojeRef - ultimaDataObjeto);
        diasDesdeUltimaCompra = Math.floor(diffTempo / (1000 * 60 * 60 * 24));

        const ultimaDataStr = ultimaDataObjeto.toISOString().split('T')[0];
        data.estoque.forEach(item => {
            const teveCompra = item.registros.some(r => r.data === ultimaDataStr && Number(r.comprada) > 0);
            if (teveCompra) itensUltimaCompra++;
        });
    }

    // ==========================================
    // 4. PREVIS√ÉO DE DIAS E GASTOS (PR√ìXIMA COMPRA)
    // ==========================================
    let textoDiasMercado = "Sem previs√£o";
    let gastoPrevisto = 0;

    const datasPrevisao = criticos
        .map(i => {
            if (!i.previsaoFim || i.previsaoFim === "Sem previs√£o") return null;
            const [dia, mes, ano] = i.previsaoFim.split('/');
            return new Date(ano, mes - 1, dia); // Criado sem o T00:00 para evitar conflito de timezone
        })
        .filter(d => d !== null);

    if (datasPrevisao.length > 0) {
        const dataMaisUrgente = new Date(Math.min(...datasPrevisao));
        const hojeCalc = new Date();
        hojeCalc.setHours(0,0,0,0);
        dataMaisUrgente.setHours(0,0,0,0);

        const diffMs = dataMaisUrgente - hojeCalc;
        const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (dias === 0) textoDiasMercado = "hoje";
        else if (dias === 1) textoDiasMercado = "amanh√£";
        else if (dias > 1) textoDiasMercado = `em ${dias} dias`;
        else if (dias === -1) textoDiasMercado = "ontem (atrasado)";
        else textoDiasMercado = "atrasou";
    }

    //---------------------------------------

    criticos.forEach(item => {
        const compras = item.registros.filter(r => Number(r.comprada) > 0 && Number(r.preco) > 0);
        const precoMedio = compras.length > 0 
            ? compras.reduce((acc, cur) => acc + Number(cur.preco), 0) / compras.length 
            : 0;
        
        const faltaParaIdeal = Math.max(0, item.quantidade_ideal - item.estoqueEstimado);
        gastoPrevisto += (faltaParaIdeal * precoMedio);
    });

    let todasAsDatasRegistros = [];
    data.estoque.forEach(item => {
        item.registros.forEach(reg => {
            todasAsDatasRegistros.push(reg.data);
        });
    });

    const datasUnicas = [...new Set(todasAsDatasRegistros)]
        .sort((a, b) => new Date(b) - new Date(a))
        .slice(0, 2);

    let eventosRecentes = [];
    data.estoque.forEach(item => {
        item.registros.forEach(reg => {
            if (datasUnicas.includes(reg.data)) {
                eventosRecentes.push({
                    nome: item.nome,
                    unidade: item.unidade_medida,
                    data: reg.data,
                    comprada: Number(reg.comprada),
                    encontrada: Number(reg.encontrada)
                });
            }
        });
    });

    eventosRecentes.sort((a, b) => new Date(b.data) - new Date(a.data));

    let ultimaDataCompra = null;
    if (todasAsDatas.length > 0) {
        ultimaDataCompra = new Date(Math.max(...todasAsDatas)).toISOString().split('T')[0];
    }

    let itensDaUltimaCompra = [];
    let valorTotalGeral = 0;

    if (ultimaDataCompra) {
        data.estoque.forEach(item => {
            const registroCompra = item.registros.find(r => r.data === ultimaDataCompra && Number(r.comprada) > 0);
            if (registroCompra) {
                const qtd = Number(registroCompra.comprada);
                const precoUnit = Number(registroCompra.preco || 0);
                const subtotal = qtd * precoUnit;
                valorTotalGeral += subtotal;
                itensDaUltimaCompra.push({
                    nome: item.nome,
                    categoria: item.categoria,
                    quantidade: qtd,
                    unidade: item.unidade_medida,
                    valorTotalItem: subtotal
                });
            }
        });
    }

    let dataTitulo = "Nenhuma compra";
    if (ultimaDataCompra) {
        const [ano, mes, dia] = ultimaDataCompra.split('-');
        dataTitulo = `${dia}/${mes}/${ano}`;
    }

    const listaSugestaoCompra = criticos.sort((a, b) => a.percentualAtual - b.percentualAtual);

    // ==========================================
    // 5. L√ìGICA DE APRENDIZADO (ALERTA)
    // ==========================================
    const itensEmAprendizado = data.estoque.filter(i => 
        i.consumo_mensuravel === 1 && 
        (i.consumoMedio === null || i.registros.length < 2)
    ).length;
%>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Listo!</title>
  <meta name="description" content="3D Glassmorphism Dashboard Template by TemplateMo">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <%- include('external/addons'); %>
</head>

<body>
  <div class="background"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="dashboard">

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">¬°L!</div>
        <span class="logo-text">Listo</span>
      </div>

      <ul class="nav-menu">
        <li class="nav-section">
          <span class="nav-section-title">A√ß√µes</span>
          <ul>
            <li class="nav-item">
              <a href="javascript:void(0)" onclick="gerenciarPaineis('resolver')" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                Vamos √†s compras
              </a>
            </li>
          </ul>
        </li>
        <li class="nav-section">
          <span class="nav-section-title">Gerenciamento</span>
          <ul>
            <li class="nav-item">
              <a href="/" class="nav-link active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7" rx="1" />
                  <rect x="14" y="3" width="7" height="7" rx="1" />
                  <rect x="3" y="14" width="7" height="7" rx="1" />
                  <rect x="14" y="14" width="7" height="7" rx="1" />
                </svg>
                Painel de controle
              </a>
            </li>
            <li class="nav-item">
              <a href="javascript:void(0)" onclick="gerenciarPaineis('inventario')" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z" />
                  <path d="M2 17l10 5 10-5" />
                  <path d="M2 12l10 5 10-5" />
                </svg>
                Todo o estoque
              </a>
            </li>
            <li class="nav-item">
              <a href="/" class="nav-link nav-upgrade">
                <div class="brilhos-container"></div> <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2v4M12 18v4M4 12H2M22 12h-2M18.364 5.636l-2.828 2.828M8.464 15.536l-2.828 2.828M18.364 18.364l-2.828-2.828M8.464 8.464L5.636 5.636" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                <span style="position: relative; z-index: 1;">Listo Scan</span>
              </a>
            </li>
          </ul>
        </li>

        <li class="nav-section">
          <span class="nav-section-title">Conta</span>
          <ul>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                  <polyline points="16 17 21 12 16 7" />
                  <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                Sair
              </a>
            </li>
          </ul>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar"><%= data.dados_usuario.nome.charAt(0).toUpperCase() %></div>
          <div class="user-info">
            <div class="user-name"><%= data.dados_usuario.nome%></div>
            <div class="user-role">Administrador</div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
      </div>
    </aside>

    <main class="main-content">

      <nav class="navbar">
        <h1 class="page-title">Minha casa</h1>
        <div class="navbar-right">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" class="search-input" placeholder="Arroz Integral">
          </div>
          <button class="nav-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
              <path d="M13.73 21a2 2 0 0 1-3.46 0" />
            </svg>
            <span class="notification-dot"></span>
          </button>
          <button class="nav-btn" id="theme-toggle" title="Toggle Light/Dark Mode">
            <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4" />
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="M4.93 4.93l1.41 1.41" />
              <path d="M17.66 17.66l1.41 1.41" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="M6.34 17.66l-1.41 1.41" />
              <path d="M19.07 4.93l-1.41 1.41" />
            </svg>
            <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        </div>
      </nav>

      <% if (itensEmAprendizado > 0) { %>
      <div id="alert-aprendizado" class="glass-card" style="margin-bottom: 20px; border-left: 4px solid var(--cyan); background: rgba(0, 210, 255, 0.05); position: relative;">
        <div style="padding: 15px; display: flex; align-items: center; gap: 15px; padding-right: 45px;">
          <div style="color: var(--cyan);">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </div>
          <div>
            <h4 style="margin: 0; font-size: 0.95rem; color: var(--text-bright);">O Listo est√° aprendendo!</h4>
            <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: var(--text-dim);">
              Ainda n√£o conhecemos o ritmo de consumo de <strong><%= itensEmAprendizado %> <%= itensEmAprendizado === 1 ? 'item' : 'itens' %></strong>.
              Continue registrando as quantidades encontradas para previs√µes precisas.
            </p>
          </div>

          <button onclick="document.getElementById('alert-aprendizado').style.display='none'" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; transition: color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--text-dim)'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <% } %>

      <div class="dashboard-viewport" style="overflow: hidden; width: 100%;">
        <div id="main-view-slider" style="display: flex; width: 200%; transition: transform 0.6s cubic-bezier(0.85, 0, 0.15, 1);">

          <div id="side-dashboard" style="width: 50%; flex-shrink: 0;">
            <section class="content-grid">

              <div class="glass-card activity-card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                    <h2 class="card-title">Cr√≠ticos</h2>
                    <p class="card-subtitle">Prioridade por data de t√©rmino</p>
                  </div>
                </div>

                <div class="activity-list">
                  <% if (criticos.length === 0) { %>
                  <p style="text-align:center; color: var(--text-dim); padding: 20px; font-size: 0.9rem;">Tudo sob controle! üéâ</p>
                  <% } %>

                  <% 
                    const criticosOrdenados = criticos.sort((a, b) => {
                        const parseData = (item) => {
                            if (item.previsaoFim === 'Hoje') return new Date();
                            if (item.previsaoFim === 'Atrasado') return new Date(0);
                            if (!item.previsaoFim || item.previsaoFim === 'Sem previs√£o') return new Date(8640000000000000);
                            const partes = item.previsaoFim.split('/');
                            return new Date(partes[2], partes[1] - 1, partes[0]);
                        };
                        const dataA = parseData(a); const dataB = parseData(b);
                        if (dataA.getTime() !== dataB.getTime()) return dataA - dataB;
                        return a.percentualAtual - b.percentualAtual;
                    });

                    criticosOrdenados.forEach(item => { 
                      let svgIcon = ''; let gradient = '';
                      switch(item.categoria) {
                          case 'Higiene': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>'; gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)'; break;
                          case 'Alimentos': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>'; gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)'; break;
                          case 'Limpeza': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>'; gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)'; break;
                          default: svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>'; gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
                      }
                      const isMuitoCritico = item.percentualAtual <= 10 || item.previsaoFim === 'Hoje' || item.previsaoFim === 'Atrasado';
                  %>
                  <div class="activity-item">
                    <div class="activity-avatar" style="background: <%= gradient %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px; position: relative;">
                      <%- svgIcon %>
                      <% if (isMuitoCritico) { %> <span style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff5e62; border-radius: 50%; border: 1px solid white;"></span> <% } %>
                    </div>
                    <div class="activity-content">
                      <p class="activity-text"><strong><%= item.nome %></strong> acabar√° em <span class="<%= isMuitoCritico ? 'text-danger' : '' %>" style="font-weight: 600;"><%= item.previsaoFim %></span></p>
                      <span class="activity-time"><%= item.estoqueEstimado %> de <%= item.quantidade_ideal %> <%= item.unidade_medida %>. (<%= item.percentualAtual %>%)</span>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>

              <div class="glass-card activity-card">
                <div class="card-header">
                  <div>
                    <h2 class="card-title">√öltimas atualiza√ß√µes</h2>
                    <p class="card-subtitle">Hist√≥rico recente</p>
                  </div>
                </div>
                <div class="activity-list">
                  <% if (eventosRecentes.length === 0) { %> <p style="text-align:center; color: var(--text-dim); padding: 20px;">Nenhuma atividade.</p> <% } %>
                  <% eventosRecentes.forEach(evento => { 
                      const [ano, mes, dia] = evento.data.split('-');
                      const dataFormatada = `${dia}/${mes}/${ano}`;
                      const ehCompra = evento.comprada > 0;
                  %>
                  <div class="activity-item">
                    <div class="activity-avatar" style="background: <%= ehCompra ? 'linear-gradient(135deg, #43e97b, #38f9d7)' : 'linear-gradient(135deg, #3a7bd5, #00d2ff)' %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
                      <% if (ehCompra) { %> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                      </svg>
                      <% } else { %> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 11a8.1 8.1 0 0 0-15.5-2m-.5-4v4h4"></path>
                        <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                      </svg> <% } %>
                    </div>
                    <div class="activity-content">
                      <p class="activity-text"><strong><%= ehCompra ? 'Compra' : 'Estoque' %></strong>: <%= ehCompra ? evento.comprada : evento.encontrada %> <%= evento.unidade %> de <%= evento.nome %></p>
                      <span class="activity-time"><%= dataFormatada %></span>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>

              <div class="glass-card activity-card">
                <div class="card-header">
                  <h2 class="card-title">√öltima compra (<%= dataTitulo %>)</h2>
                  <p class="card-subtitle">Total: <strong>R$ <%= valorTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></strong></p>
                </div>
                <div class="activity-list">
                  <% itensDaUltimaCompra.forEach(item => { 
                      let grad = (item.categoria === 'Higiene') ? 'linear-gradient(135deg, #00d2ff, #3a7bd5)' : (item.categoria === 'Alimentos') ? 'linear-gradient(135deg, #ff9966, #ff5e62)' : 'linear-gradient(135deg, #43e97b, #38f9d7)';
                  %>
                  <div class="activity-item">
                    <div class="activity-avatar" style="background: <%= grad %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v4l3 3"></path>
                      </svg>
                    </div>
                    <div class="activity-content">
                      <p class="activity-text"><strong><%= item.nome %></strong>. <%= item.quantidade %> <%= item.unidade %>.</p>
                      <span class="activity-time">R$ <%= item.valorTotalItem.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>

              <div class="glass-card activity-card">
                <div class="card-header">
                  <h2 class="card-title">Pr√≥xima compra <%= textoDiasMercado %></h2>
                  <p class="card-subtitle">Gasto: <strong>R$ <%= gastoPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></strong></p>
                </div>
                <div class="activity-list">
                  <% listaSugestaoCompra.forEach(item => { 
                      const qto = Math.max(0, item.quantidade_ideal - item.estoqueEstimado);
                  %>
                  <div class="activity-item">
                    <div class="activity-avatar" style="background: var(--glass-border); color: white; display: flex; align-items: center; justify-content: center; padding: 8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14" />
                      </svg></div>
                    <div class="activity-content">
                      <p class="activity-text"><strong>Comprar <%= qto.toFixed(1) %> <%= item.unidade_medida %></strong> de <%= item.nome %></p>
                      <span class="activity-time"><%= item.percentualAtual %>% em estoque</span>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>

            </section>
          </div>


          <!--Lista de compras-->
          <div id="side-resolver" style="width: 50%; flex-shrink: 0; padding: 0 15px; overflow-y: auto; display: none;">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 5px;">
              <div>
                <h2 class="page-title" style="margin:0; font-size: 1.5rem; color: var(--dynamic-text);">Resolver</h2>
                <p class="card-subtitle">Confirme o estoque real ou as compras</p>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="salvarTudo()" class="card-btn" style="background: var(--emerald); color: white; border: none;">Confirmar</button>
              </div>
            </div>

            <section class="content-grid">

              <div class="glass-card" style="height: 80vh; display: flex; flex-direction: column;">
                <div class="card-header" style="flex-shrink: 0;">
                  <h2 class="card-title">Itens Cr√≠ticos</h2>
                </div>
                <div class="activity-list" style="flex-grow: 1; overflow-y: auto; padding-right: 5px;">
                  <% 
          criticos.forEach(item => { 
            let svgIcon = ''; let gradient = '';
            switch(item.categoria) {
                case 'Higiene': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>'; gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)'; break;
                case 'Alimentos': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>'; gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)'; break;
                case 'Limpeza': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>'; gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)'; break;
                default: svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>'; gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
            }
            const isMuitoCritico = item.percentualAtual <= 10 || item.previsaoFim === 'Hoje' || item.previsaoFim === 'Atrasado';
        %>
                  <div class="activity-item" style="padding: 15px 0; border-bottom: 1px solid var(--glass-border); align-items: center;">
                    <div class="activity-avatar" style="background: <%= gradient %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px; position: relative; flex-shrink: 0;">
                      <%- svgIcon %>
                      <% if (isMuitoCritico) { %> <span style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff5e62; border-radius: 50%; border: 1px solid white;"></span> <% } %>
                    </div>
                    <div class="activity-content" style="flex-grow: 1;">
                      <p class="activity-text" style="color: var(--dynamic-text);"><strong><%= item.nome %></strong></p>
                      <span class="activity-time" style="color: var(--dynamic-subtext);">Meta: <%= item.quantidade_ideal %></span>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 5px; min-width: 90px;">
                      <div class="pill-input-group">
                        <button onclick="changeQty(this, -1)">-</button>
                        <span class="qty-val" style="color: var(--dynamic-text);"><%= Math.round(item.estoqueEstimado) %></span>
                        <button onclick="changeQty(this, 1)">+</button>
                      </div>
                      <div class="pill-input-group" style="border-color: var(--emerald);">
                        <button onclick="changeQty(this, -1)" style="color: var(--emerald)">-</button>
                        <span class="qty-val" style="color: var(--emerald)">0</span>
                        <button onclick="changeQty(this, 1)" style="color: var(--emerald)">+</button>
                      </div>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>

              <div class="glass-card" style="height: 80vh; display: flex; flex-direction: column;">
                <div class="card-header" style="flex-shrink: 0;">
                  <h2 class="card-title">Mais alguma coisa?</h2>
                </div>
                <div class="activity-list" style="flex-grow: 1; overflow-y: auto; padding-right: 5px;">
                  <% 
          const idsResolvidos = criticos.map(c => c.id);
          data.estoque
            .filter(i => !idsResolvidos.includes(i.id))
            .sort((a, b) => a.nome.localeCompare(b.nome))
            .forEach(item => { 
              let svgIcon = ''; let gradient = '';
              switch(item.categoria) {
                  case 'Higiene': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>'; gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)'; break;
                  case 'Alimentos': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>'; gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)'; break;
                  case 'Limpeza': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>'; gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)'; break;
                  default: svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>'; gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
              }
        %>
                  <div class="activity-item" style="padding: 15px 0; border-bottom: 1px solid var(--glass-border); align-items: center;">
                    <div class="activity-avatar" style="background: <%= gradient %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px; flex-shrink: 0;">
                      <%- svgIcon %>
                    </div>
                    <div class="activity-content" style="flex-grow: 1;">
                      <p class="activity-text" style="color: var(--dynamic-text);"><strong><%= item.nome %></strong></p>
                      <span class="activity-time" style="color: var(--dynamic-subtext);">Tem: <%= Math.round(item.estoqueEstimado) %></span>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 5px; min-width: 90px;">
                      <div class="pill-input-group">
                        <button onclick="changeQty(this, -1)">-</button>
                        <span class="qty-val" style="color: var(--dynamic-text);"><%= Math.round(item.estoqueEstimado) %></span>
                        <button onclick="changeQty(this, 1)">+</button>
                      </div>
                      <div class="pill-input-group" style="border-color: var(--emerald);">
                        <button onclick="changeQty(this, -1)" style="color: var(--emerald)">-</button>
                        <span class="qty-val" style="color: var(--emerald)">0</span>
                        <button onclick="changeQty(this, 1)" style="color: var(--emerald)">+</button>
                      </div>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>
            </section>

            <div style="height: 120px;"></div>
          </div>


          <div id="side-inventario" style="width: 50%; flex-shrink: 0; padding: 0 15px; overflow-y: auto; display: none;">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 5px;">
              <div>
                <h2 class="page-title" style="margin:0; font-size: 1.5rem; color: var(--dynamic-text);">Invent√°rio Geral</h2>
                <p class="card-subtitle">Consulta r√°pida de todos os itens</p>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="toggleInventoryView(false)" class="card-btn" style="border-color: var(--coral); color: var(--coral); background: none;">Sair</button>
              </div>
            </div>

            <section class="content-grid">


              <!-- Activity Feed -->
              <div class="glass-card activity-card">
                <div class="card-header">
                  <div>
                    <h2 class="card-title">Cozinha Completa</h2>
                    <p class="card-subtitle">Invent√°rio detalhado da despensa</p>
                  </div>
                </div>
                <div class="activity-list">

                  <% 
      const cozinhaItens = data.estoque
        .filter(i => i.categoria === 'Alimentos')
        .sort((a, b) => a.nome.localeCompare(b.nome));

      if (cozinhaItens.length === 0) { %>
                  <div style="text-align:center; color: var(--text-dim); padding: 30px;">
                    <p style="font-size: 0.9rem;">Sua despensa est√° vazia no sistema. üç≥</p>
                  </div>
                  <% } %>

                  <% cozinhaItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>

                  <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                    <div style="display: flex; align-items: center; flex: 1;">
                      <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                          <path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" />
                          <path d="M12 7c0-2 1-4 3-5" />
                        </svg>
                      </div>

                      <div class="activity-content" style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                          <p class="activity-text" style="margin: 0;">
                            <strong style="font-size: 1rem;"><%= item.nome %></strong>
                            <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                          </p>
                          <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                            <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                          </span>
                        </div>

                        <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                          <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                      </div>
                    </div>

                    <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                      <a href="/estoque/editar/<%= item.id %>" title="Editar" style="color: var(--text-dim); transition: all 0.2s;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                        </svg>
                      </a>

                      <a href="/estoque/deletar/<%= item.id %>" title="Excluir" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6; transition: all 0.2s;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                      </a>
                    </div>
                  </div>

                  <% }) %>

                </div>
              </div>
              <div class="glass-card activity-card">
                <div class="card-header">
                  <div>
                    <h2 class="card-title">Higiene</h2>
                    <p class="card-subtitle">Cuidados e uso pessoal</p>
                  </div>
                </div>
                <div class="activity-list">
                  <% 
      const higieneItens = data.estoque
        .filter(i => i.categoria === 'Higiene')
        .sort((a, b) => a.nome.localeCompare(b.nome));

      higieneItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>
                  <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                    <div style="display: flex; align-items: center; flex: 1;">
                      <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                          <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                        </svg>
                      </div>
                      <div class="activity-content" style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                          <p class="activity-text" style="margin: 0;">
                            <strong style="font-size: 1rem;"><%= item.nome %></strong>
                            <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                          </p>
                          <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                            <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                          </span>
                        </div>
                        <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                          <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                      <a href="/estoque/editar/<%= item.id %>" style="color: var(--text-dim);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                        </svg></a>
                      <a href="/estoque/deletar/<%= item.id %>" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg></a>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>

              <!-- Data Table -->
              <div class="glass-card activity-card">
                <div class="card-header">
                  <div>
                    <h2 class="card-title">Limpeza</h2>
                    <p class="card-subtitle">Manuten√ß√£o da casa</p>
                  </div>
                </div>
                <div class="activity-list">
                  <% 
      const limpezaItens = data.estoque
        .filter(i => i.categoria === 'Limpeza')
        .sort((a, b) => a.nome.localeCompare(b.nome));

      limpezaItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>
                  <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                    <div style="display: flex; align-items: center; flex: 1;">
                      <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                          <path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                        </svg>
                      </div>
                      <div class="activity-content" style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                          <p class="activity-text" style="margin: 0;">
                            <strong style="font-size: 1rem;"><%= item.nome %></strong>
                            <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                          </p>
                          <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                            <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                          </span>
                        </div>
                        <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                          <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                      <a href="/estoque/editar/<%= item.id %>" style="color: var(--text-dim);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                        </svg></a>
                      <a href="/estoque/deletar/<%= item.id %>" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg></a>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>
              <div class="glass-card activity-card">
                <div class="card-header">
                  <div>
                    <h2 class="card-title">Outros</h2>
                    <p class="card-subtitle">Reposi√ß√£o e itens diversos</p>
                  </div>
                </div>
                <div class="activity-list">
                  <% 
      const outrosItens = data.estoque
        .filter(i => i.categoria === 'Outro' || (i.categoria !== 'Alimentos' && i.categoria !== 'Higiene' && i.categoria !== 'Limpeza'))
        .sort((a, b) => a.nome.localeCompare(b.nome));

      outrosItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>
                  <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
                    <div style="display: flex; align-items: center; flex: 1;">
                      <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                          <circle cx="12" cy="12" r="10" />
                          <line x1="12" y1="8" x2="12" y2="12" />
                          <line x1="12" y1="16" x2="12.01" y2="16" />
                        </svg>
                      </div>
                      <div class="activity-content" style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                          <p class="activity-text" style="margin: 0;">
                            <strong style="font-size: 1rem;"><%= item.nome %></strong>
                            <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                          </p>
                          <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                            <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                          </span>
                        </div>
                        <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                          <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                      </div>
                    </div>
                    <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                      <a href="/estoque/editar/<%= item.id %>" style="color: var(--text-dim);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                        </svg></a>
                      <a href="/estoque/deletar/<%= item.id %>" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg></a>
                    </div>
                  </div>
                  <% }) %>
                </div>
              </div>
            </section>
          </div>

          <div id="side-scan" style="width: 50%; flex-shrink: 0; padding: 0 15px; overflow-y: auto; display: none;">

            <div style="display: flex; justify-content: space-between; align-items: center; height: 80px; padding: 15px 5px;">
              <div>
                <h2 class="page-title" style="margin:0; font-size: 1.5rem; color: var(--dynamic-text);">Resolver Estoque</h2>
                <p class="card-subtitle">Ajuste fino categoria por categoria</p>
              </div>
              <button onclick="salvarTudo()" class="card-btn" style="background: var(--emerald); color: white; border: none; padding: 10px 25px;">Finalizar Tudo</button>
            </div>

            <section class="content-grid">

              <% 
            const configTinder = [
                { id: 'cozinha', titulo: 'Cozinha', cat: 'Alimentos', cor: 'linear-gradient(135deg, #ff9966, #ff5e62)' },
                { id: 'higiene', titulo: 'Higiene', cat: 'Higiene', cor: 'linear-gradient(135deg, #00d2ff, #3a7bd5)' },
                { id: 'limpeza', titulo: 'Limpeza', cat: 'Limpeza', cor: 'linear-gradient(135deg, #43e97b, #38f9d7)' },
                { id: 'geral', titulo: 'Gerais', cat: 'Outro', cor: 'linear-gradient(135deg, #667eea, #764ba2)' }
            ];

            configTinder.forEach(tinder => {
                const itens = data.estoque.filter(i => {
                    return (tinder.cat === 'Outro') ? 
                        (i.categoria === 'Outro' || !['Alimentos','Higiene','Limpeza'].includes(i.categoria)) : 
                        (i.categoria === tinder.cat);
                });
        %>

              <div class="glass-card tinder-card" id="tinder-<%= tinder.id %>" style="display: flex; flex-direction: column; overflow: hidden; position: relative; padding: 15px;">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <span style="font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: var(--dynamic-subtext);"><%= tinder.titulo %></span>
                  <span class="tinder-counter" style="font-size: 0.7rem; opacity: 0.6;">1 / <%= itens.length %></span>
                </div>

                <div class="tinder-track" style="flex: 1; display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: <%= itens.length * 100 %>%;">

                  <% itens.forEach((item, index) => { 
    // Seus SVGs originais
    let svgIcon = ''; 
    switch(item.categoria) {
        case 'Higiene': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>'; break;
        case 'Alimentos': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>'; break;
        case 'Limpeza': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>'; break;
        default: svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>';
    }
%>
<div class="tinder-item" style="width: <%= 100 / itens.length %>%; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center;">

    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; width: 100%; padding: 0 15px;">
        
        <div class="activity-avatar" style="background: <%= tinder.cor %>; min-width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; box-shadow: 0 8px 20px rgba(0,0,0,0.1);">
            <div style="width: 35px;"><%- svgIcon %></div>
        </div>

        <div style="flex-grow: 1; text-align: left;">
            <h3 style="margin: 0; font-size: 1.2rem; color: var(--dynamic-text);"><%= item.nome %></h3>
            <p style="font-size: 0.75rem; color: var(--dynamic-subtext); margin: 2px 0 8px 0;">Meta: <%= item.quantidade_ideal %></p>
            
            <div class="progress-bar" style="width: 100%; height: 8px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                <div id="bar-<%= item.id %>" 
                     data-ideal="<%= item.quantidade_ideal %>"
                     style="width: <%= Math.min(100, (item.estoqueEstimado / item.quantidade_ideal) * 100) %>%; 
                            height: 100%; 
                            background: <%= tinder.cor %>; 
                            transition: width 0.3s ease;">
                </div>
            </div>
        </div>
    </div>

    <div class="pill-input-group" style="display: flex; align-items: center; gap: 25px; background: rgba(0,0,0,0.03); padding: 12px 25px; border-radius: 50px; border: 1px solid var(--glass-border);">
        <button onclick="updateTinderQty('<%= item.id %>', -1)" style="border: none; background: none; font-size: 1.8rem; cursor: pointer; color: var(--primary); font-weight: bold;">-</button>
        <span id="val-<%= item.id %>" class="qty-val" style="font-size: 2.2rem; font-weight: 800; min-width: 60px; color: var(--dynamic-text);"><%= Math.round(item.estoqueEstimado) %></span>
        <button onclick="updateTinderQty('<%= item.id %>', 1)" style="border: none; background: none; font-size: 1.8rem; cursor: pointer; color: var(--primary); font-weight: bold;">+</button>
    </div>

    <p style="font-size: 0.7rem; color: var(--dynamic-subtext); margin-top: 15px;">√öltima compra: <%= item.data_ultima_compra || 'N/A' %></p>
</div>
<% }) %>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                  <button onclick="moveTinder('<%= tinder.id %>', -1)" style="background: none; border: none; cursor: pointer; opacity: 0.4;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M15 18l-6-6 6-6" />
                    </svg>
                  </button>
                  <button onclick="moveTinder('<%= tinder.id %>', 1)" style="background: none; border: none; cursor: pointer; opacity: 0.4;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M9 18l6-6-6-6" />
                    </svg>
                  </button>
                </div>
              </div>
              <% }) %>

            </section>
          </div>

        </div>
      </div>
    </main>
  </div>

  <button class="mobile-menu-toggle">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12" />
      <line x1="3" y1="6" x2="21" y2="6" />
      <line x1="3" y1="18" x2="21" y2="18" />
    </svg>
  </button>

  <footer class="site-footer">
    <p>Copyright ¬© 2026 Dev: Mateus Kaufmann ¬∑ UI: TemplateMo</p>
  </footer>

  <script>
    function toggleView(isResolver) {
      const slider = document.getElementById('main-view-slider');
      if (slider) {
        slider.style.transform = isResolver ? 'translateX(-50%)' : 'translateX(0%)';
      }
    }

    function changeQty(btn, delta) {
      const span = btn.parentElement.querySelector('.qty-val');
      let val = parseInt(span.innerText) || 0;
      if (val + delta >= 0) span.innerText = val + delta;
    }
  </script>
</body>

</html>