<% 
    // ==========================================
    // 1. FILTROS E CONTAGENS B√ÅSICAS
    // ==========================================
    const totalItens = data.estoque.length;
    
    // Itens Cr√≠ticos (Abaixo do alerta e mensur√°veis)
    const criticosRaw = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta && 
        i.consumo_mensuravel === 1
    );

    // ORDENA√á√ÉO POR T√âRMINO (O que acaba antes no topo)
    const criticos = criticosRaw.sort((a, b) => {
        const converterData = (dataStr) => {
            if (!dataStr || dataStr === 'N/A' || dataStr === 'Listo est√° aprendendo o consumo...') return new Date(8640000000000000);
            const [dia, mes, ano] = dataStr.split('/');
            return new Date(ano, mes - 1, dia);
        };
        const dataA = converterData(a.previsaoFim);
        const dataB = converterData(b.previsaoFim);
        
        // Se as datas forem iguais, desempata pelo menor percentual
        if (dataA.getTime() === dataB.getTime()) {
            return a.percentualAtual - b.percentualAtual;
        }
        return dataA - dataB;
    });

    // Itens Saud√°veis
    const itensOk = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual > i.percentual_alerta
    ).length;

    // Itens que precisam de aten√ß√£o (Todos abaixo do alerta)
    const contagemAtencao = data.estoque.filter(i => 
        i.percentualAtual !== null && 
        i.percentualAtual <= i.percentual_alerta
    ).length;

    // ==========================================
    // 2. C√ÅLCULOS DE SA√öDE (PORCENTAGENS)
    // ==========================================
    const percAtencao = totalItens > 0 ? Math.round((contagemAtencao / totalItens) * 100) : 0;
    const percOk = totalItens > 0 ? Math.round((itensOk / totalItens) * 100) : 0;

    // ==========================================
    // 3. L√ìGICA DE √öLTIMA COMPRA
    // ==========================================
    const todasAsDatas = data.estoque
        .map(i => i.data_ultima_compra)
        .filter(d => d !== null)
        .map(d => new Date(d + 'T00:00:00'));

    let diasDesdeUltimaCompra = "---";
    let itensUltimaCompra = 0;

    if (todasAsDatas.length > 0) {
        const ultimaDataObjeto = new Date(Math.max(...todasAsDatas));
        const hojeRef = new Date();
        hojeRef.setHours(0,0,0,0);
        
        const diffTempo = Math.abs(hojeRef - ultimaDataObjeto);
        diasDesdeUltimaCompra = Math.floor(diffTempo / (1000 * 60 * 60 * 24));

        const ultimaDataStr = ultimaDataObjeto.toISOString().split('T')[0];
        data.estoque.forEach(item => {
            const teveCompra = item.registros.some(r => r.data === ultimaDataStr && Number(r.comprada) > 0);
            if (teveCompra) itensUltimaCompra++;
        });
    }

    // ==========================================
    // 4. PREVIS√ÉO DE DIAS E GASTOS (PR√ìXIMA COMPRA)
    // ==========================================
    let textoDiasMercado = "Hoje";
    let gastoPrevisto = 0;

    const datasPrevisao = criticos
        .map(i => {
            if (!i.previsaoFim || i.previsaoFim === 'Listo est√° aprendendo o consumo...') return null;
            const [dia, mes, ano] = i.previsaoFim.split('/');
            return new Date(`${ano}-${mes}-${dia}T00:00:00`);
        })
        .filter(d => d !== null);

    if (datasPrevisao.length > 0) {
        const dataMaisUrgente = new Date(Math.min(...datasPrevisao));
        const hojeCalc = new Date();
        hojeCalc.setHours(0,0,0,0);
        const diffMs = dataMaisUrgente - hojeCalc;
        const dias = Math.round(diffMs / (1000 * 60 * 60 * 24));

        if (dias > 1) textoDiasMercado = `Faltam ${dias} dias`;
        else if (dias === 1) textoDiasMercado = "Falta 1 dia";
        else if (dias === 0) textoDiasMercado = "√â hoje!";
        else textoDiasMercado = "Atrasado";
    }

    criticos.forEach(item => {
        const compras = item.registros.filter(r => Number(r.comprada) > 0 && Number(r.preco) > 0);
        const ultimoPrecoCompra = compras.length > 0 ? Number(compras[compras.length - 1].preco) : 0;
        
        const faltaParaIdeal = Math.max(0, item.quantidade_ideal - item.estoqueEstimado);
        gastoPrevisto += (faltaParaIdeal * ultimoPrecoCompra);
    });

    let todasAsDatasRegistros = [];
    data.estoque.forEach(item => {
        item.registros.forEach(reg => {
            todasAsDatasRegistros.push(reg.data);
        });
    });

    const datasUnicas = [...new Set(todasAsDatasRegistros)]
        .sort((a, b) => new Date(b) - new Date(a))
        .slice(0, 2);

    let eventosRecentes = [];
    data.estoque.forEach(item => {
        item.registros.forEach(reg => {
            if (datasUnicas.includes(reg.data)) {
                eventosRecentes.push({
                    nome: item.nome,
                    unidade: item.unidade_medida,
                    data: reg.data,
                    comprada: Number(reg.comprada),
                    encontrada: Number(reg.encontrada)
                });
            }
        });
    });

    eventosRecentes.sort((a, b) => new Date(b.data) - new Date(a.data));

    let ultimaDataCompra = null;
    if (todasAsDatas.length > 0) {
        ultimaDataCompra = new Date(Math.max(...todasAsDatas)).toISOString().split('T')[0];
    }

    let itensDaUltimaCompra = [];
    let valorTotalGeral = 0;

    if (ultimaDataCompra) {
        data.estoque.forEach(item => {
            const registroCompra = item.registros.find(r => r.data === ultimaDataCompra && Number(r.comprada) > 0);
            if (registroCompra) {
                const qtd = Number(registroCompra.comprada);
                const precoUnit = Number(registroCompra.preco || 0);
                const subtotal = qtd * precoUnit;
                valorTotalGeral += subtotal;
                itensDaUltimaCompra.push({
                    nome: item.nome,
                    categoria: item.categoria,
                    quantidade: qtd,
                    unidade: item.unidade_medida,
                    valorTotalItem: subtotal
                });
            }
        });
    }

    let dataTitulo = "Nenhuma compra";
    if (ultimaDataCompra) {
        const [ano, mes, dia] = ultimaDataCompra.split('-');
        dataTitulo = `${dia}/${mes}/${ano}`;
    }

    const listaSugestaoCompra = criticos.sort((a, b) => a.percentualAtual - b.percentualAtual);
%>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Listo!</title>
  <meta name="description" content="3D Glassmorphism Dashboard Template by TemplateMo">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <%- include('external/addons'); %>
  <!--

TemplateMo 607 Glass Admin

https://templatemo.com/tm-607-glass-admin

-->
</head>

<body>
  <!-- Animated Background -->
  <div class="background"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>

  <div class="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">¬°L!</div>
        <span class="logo-text">Listo</span>
      </div>

      <ul class="nav-menu">
        <li class="nav-section">
          <span class="nav-section-title">Navega√ß√£o</span>
          <ul>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="7" height="7" rx="1" />
                  <rect x="14" y="3" width="7" height="7" rx="1" />
                  <rect x="3" y="14" width="7" height="7" rx="1" />
                  <rect x="14" y="14" width="7" height="7" rx="1" />
                </svg>
                Painel de controle
              </a>
            </li>
            <li class="nav-item">
              <a href="/" class="nav-link active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 2L2 7l10 5 10-5-10-5z" />
                  <path d="M2 17l10 5 10-5" />
                  <path d="M2 12l10 5 10-5" />
                </svg>
                Todo o estoque
              </a>
            </li>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2v4M12 18v4M4 12H2M22 12h-2M18.364 5.636l-2.828 2.828M8.464 15.536l-2.828 2.828M18.364 18.364l-2.828-2.828M8.464 8.464L5.636 5.636" />
                  <circle cx="12" cy="12" r="3" />
                </svg>
                Inciar assistente
              </a>
            </li>
          </ul>
        </li>

        <li class="nav-section">
          <span class="nav-section-title">Conta</span>
          <ul>
            <li class="nav-item">
              <a href="/" class="nav-link">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                  <polyline points="16 17 21 12 16 7" />
                  <line x1="21" y1="12" x2="9" y2="12" />
                </svg>
                Sair
              </a>
            </li>
          </ul>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar"><%= data.dados_usuario.nome.charAt(0).toUpperCase() %></div>
          <div class="user-info">
            <div class="user-name"><%= data.dados_usuario.nome%></div>
            <div class="user-role">Administrador</div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navbar -->
      <nav class="navbar">
        <h1 class="page-title">Estoque</h1>
        <div class="navbar-right">
          <div class="search-box">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input type="text" class="search-input" placeholder="Arroz Integral">
          </div>
          <button class="nav-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
              <path d="M13.73 21a2 2 0 0 1-3.46 0" />
            </svg>
            <span class="notification-dot"></span>
          </button>
          <button class="nav-btn" id="theme-toggle" title="Toggle Light/Dark Mode">
            <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4" />
              <path d="M12 2v2" />
              <path d="M12 20v2" />
              <path d="M4.93 4.93l1.41 1.41" />
              <path d="M17.66 17.66l1.41 1.41" />
              <path d="M2 12h2" />
              <path d="M20 12h2" />
              <path d="M6.34 17.66l-1.41 1.41" />
              <path d="M19.07 4.93l-1.41 1.41" />
            </svg>
            <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        </div>
      </nav>

      <!-- Content Grid -->
      <section class="content-grid">


        <!-- Activity Feed -->
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Cozinha Completa</h2>
              <p class="card-subtitle">Invent√°rio detalhado da despensa</p>
            </div>
          </div>
          <div class="activity-list">

            <% 
      const cozinhaItens = data.estoque
        .filter(i => i.categoria === 'Alimentos')
        .sort((a, b) => a.nome.localeCompare(b.nome));

      if (cozinhaItens.length === 0) { %>
            <div style="text-align:center; color: var(--text-dim); padding: 30px;">
              <p style="font-size: 0.9rem;">Sua despensa est√° vazia no sistema. üç≥</p>
            </div>
            <% } %>

            <% cozinhaItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>

            <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                    <path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" />
                    <path d="M12 7c0-2 1-4 3-5" />
                  </svg>
                </div>

                <div class="activity-content" style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                    <p class="activity-text" style="margin: 0;">
                      <strong style="font-size: 1rem;"><%= item.nome %></strong>
                      <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                    </p>
                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                      <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                    </span>
                  </div>

                  <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                    <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                  </div>
                </div>
              </div>

              <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                <a href="/estoque/editar/<%= item.id %>" title="Editar" style="color: var(--text-dim); transition: all 0.2s;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                  </svg>
                </a>

                <a href="/estoque/deletar/<%= item.id %>" title="Excluir" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6; transition: all 0.2s;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </a>
              </div>
            </div>

            <% }) %>

          </div>
        </div>
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Higiene</h2>
              <p class="card-subtitle">Cuidados e uso pessoal</p>
            </div>
          </div>
          <div class="activity-list">
            <% 
      const higieneItens = data.estoque
        .filter(i => i.categoria === 'Higiene')
        .sort((a, b) => a.nome.localeCompare(b.nome));

      higieneItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>
            <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                  </svg>
                </div>
                <div class="activity-content" style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                    <p class="activity-text" style="margin: 0;">
                      <strong style="font-size: 1rem;"><%= item.nome %></strong>
                      <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                    </p>
                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                      <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                    </span>
                  </div>
                  <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                    <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                  </div>
                </div>
              </div>
              <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                <a href="/estoque/editar/<%= item.id %>" style="color: var(--text-dim);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                  </svg></a>
                <a href="/estoque/deletar/<%= item.id %>" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg></a>
              </div>
            </div>
            <% }) %>
          </div>
        </div>

        <!-- Data Table -->
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Limpeza</h2>
              <p class="card-subtitle">Manuten√ß√£o da casa</p>
            </div>
          </div>
          <div class="activity-list">
            <% 
      const limpezaItens = data.estoque
        .filter(i => i.categoria === 'Limpeza')
        .sort((a, b) => a.nome.localeCompare(b.nome));

      limpezaItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>
            <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                    <path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                  </svg>
                </div>
                <div class="activity-content" style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                    <p class="activity-text" style="margin: 0;">
                      <strong style="font-size: 1rem;"><%= item.nome %></strong>
                      <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                    </p>
                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                      <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                    </span>
                  </div>
                  <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                    <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                  </div>
                </div>
              </div>
              <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                <a href="/estoque/editar/<%= item.id %>" style="color: var(--text-dim);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                  </svg></a>
                <a href="/estoque/deletar/<%= item.id %>" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg></a>
              </div>
            </div>
            <% }) %>
          </div>
        </div>
        <div class="glass-card activity-card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Outros</h2>
              <p class="card-subtitle">Reposi√ß√£o e itens diversos</p>
            </div>
          </div>
          <div class="activity-list">
            <% 
      const outrosItens = data.estoque
        .filter(i => i.categoria === 'Outro' || (i.categoria !== 'Alimentos' && i.categoria !== 'Higiene' && i.categoria !== 'Limpeza'))
        .sort((a, b) => a.nome.localeCompare(b.nome));

      outrosItens.forEach(item => { 
        let statusColor = 'var(--emerald)'; 
        if (item.percentualAtual <= item.percentual_alerta) statusColor = '#ff9966';
        if (item.percentualAtual <= 10) statusColor = '#ff5e62';
    %>
            <div class="activity-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px;">
              <div style="display: flex; align-items: center; flex: 1;">
                <div class="activity-avatar" style="background: <%= statusColor %>; color: white; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; border-radius: 10px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px;">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                  </svg>
                </div>
                <div class="activity-content" style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4px;">
                    <p class="activity-text" style="margin: 0;">
                      <strong style="font-size: 1rem;"><%= item.nome %></strong>
                      <span style="font-size: 0.8rem; color: var(--text-dim); margin-left: 8px; font-weight: 500;"><%= item.percentualAtual %>%</span>
                    </p>
                    <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-main);">
                      <%= item.estoqueEstimado %> <span style="font-weight: 400; color: var(--text-dim);">/ <%= item.quantidade_ideal %> <%= item.unidade_medida %></span>
                    </span>
                  </div>
                  <div class="progress-bar" style="height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden;">
                    <div class="progress-fill" style="width: <%= item.percentualAtual %>%; background: <%= statusColor %>; height: 100%; transition: width 0.5s ease;"></div>
                  </div>
                </div>
              </div>
              <div class="item-actions" style="display: flex; gap: 12px; margin-left: 20px; border-left: 1px solid rgba(0,0,0,0.05); padding-left: 15px;">
                <a href="/estoque/editar/<%= item.id %>" style="color: var(--text-dim);"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path>
                  </svg></a>
                <a href="/estoque/deletar/<%= item.id %>" onclick="return confirm('Excluir <%= item.nome %>?')" style="color: #ff5e62; opacity: 0.6;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg></a>
              </div>
            </div>
            <% }) %>
          </div>
        </div>
      </section>

      <!-- Bottom Grid -->

    </main>
  </div>

  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12" />
      <line x1="3" y1="6" x2="21" y2="6" />
      <line x1="3" y1="18" x2="21" y2="18" />
    </svg>
  </button>

  <!-- Footer -->
  <footer class="site-footer">
    <p>Copyright ¬© 2026 Dev: Mateus Kaufmann ¬∑ UI: TemplateMo</p>
  </footer>
  <!-- TemplateMo 607 Glass Admin -->
</body>

</html>