<%# Partial: painel principal (Cr√≠ticos, √öltimas atualiza√ß√µes, √öltima compra, Pr√≥xima compra) %>
<div id="side-dashboard" style="width: 50%; flex-shrink: 0;">
  <section class="content-grid">

    <div class="glass-card activity-card">
      <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h2 class="card-title">Cr√≠ticos</h2>
          <p class="card-subtitle">Prioridade por data de t√©rmino</p>
        </div>
      </div>

      <div class="activity-list">
        <% if (criticos.length === 0) { %>
        <p style="text-align:center; color: var(--text-dim); padding: 20px; font-size: 0.9rem;">Tudo sob controle! üéâ</p>
        <% } %>

        <% 
          const criticosOrdenados = criticos.sort((a, b) => {
              const parseData = (item) => {
                  if (item.previsaoFim === 'Hoje') return new Date();
                  if (item.previsaoFim === 'Atrasado') return new Date(0);
                  if (!item.previsaoFim || item.previsaoFim === 'Sem previs√£o') return new Date(8640000000000000);
                  const partes = item.previsaoFim.split('/');
                  return new Date(partes[2], partes[1] - 1, partes[0]);
              };
              const dataA = parseData(a); const dataB = parseData(b);
              if (dataA.getTime() !== dataB.getTime()) return dataA - dataB;
              return a.percentualAtual - b.percentualAtual;
          });

          criticosOrdenados.forEach(item => { 
            let svgIcon = ''; let gradient = '';
            switch(item.categoria) {
                case 'Higiene': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /></svg>'; gradient = 'linear-gradient(135deg, #00d2ff, #3a7bd5)'; break;
                case 'Alimentos': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 7c-4 0-7 3-7 8a7 7 0 0 0 14 0c0-5-3-8-7-8z" /><path d="M12 7c0-2 1-4 3-5" /></svg>'; gradient = 'linear-gradient(135deg, #ff9966, #ff5e62)'; break;
                case 'Limpeza': svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6M10 3v4M14 7H8a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" /></svg>'; gradient = 'linear-gradient(135deg, #43e97b, #38f9d7)'; break;
                default: svgIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /></svg>'; gradient = 'linear-gradient(135deg, #667eea, #764ba2)';
            }
            const isMuitoCritico = item.percentualAtual <= 10 || item.previsaoFim === 'Hoje' || item.previsaoFim === 'Atrasado';
        %>
        <div class="activity-item">
          <div class="activity-avatar" style="background: <%= gradient %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px; position: relative;">
            <%- svgIcon %>
            <% if (isMuitoCritico) { %> <span style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff5e62; border-radius: 50%; border: 1px solid white;"></span> <% } %>
          </div>
          <div class="activity-content">
            <p class="activity-text"><strong><%= item.nome %></strong> acabar√° em <span class="<%= isMuitoCritico ? 'text-danger' : '' %>" style="font-weight: 600;"><%= item.previsaoFim %></span></p>
            <span class="activity-time"><%= item.estoqueEstimado %> de <%= item.quantidade_ideal %> <%= item.unidade_medida %>. (<%= item.percentualAtual %>%)</span>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <div class="glass-card activity-card">
      <div class="card-header">
        <div>
          <h2 class="card-title">√öltimas atualiza√ß√µes</h2>
          <p class="card-subtitle">Hist√≥rico recente</p>
        </div>
      </div>
      <div class="activity-list">
        <% if (eventosRecentes.length === 0) { %> <p style="text-align:center; color: var(--text-dim); padding: 20px;">Nenhuma atividade.</p> <% } %>
        <% eventosRecentes.forEach(evento => { 
            const [ano, mes, dia] = evento.data.split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;
            const ehCompra = evento.comprada > 0;
        %>
        <div class="activity-item">
          <div class="activity-avatar" style="background: <%= ehCompra ? 'linear-gradient(135deg, #43e97b, #38f9d7)' : 'linear-gradient(135deg, #3a7bd5, #00d2ff)' %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
            <% if (ehCompra) { %> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <% } else { %> <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 11a8.1 8.1 0 0 0-15.5-2m-.5-4v4h4"></path>
              <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
            </svg> <% } %>
          </div>
          <div class="activity-content">
            <p class="activity-text"><strong><%= ehCompra ? 'Compra' : 'Estoque' %></strong>: <%= ehCompra ? evento.comprada : evento.encontrada %> <%= evento.unidade %> de <%= evento.nome %></p>
            <span class="activity-time"><%= dataFormatada %></span>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <div class="glass-card activity-card">
      <div class="card-header">
        <h2 class="card-title">√öltima compra (<%= dataTitulo %>)</h2>
        <p class="card-subtitle">Total: <strong>R$ <%= valorTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></strong></p>
      </div>
      <div class="activity-list">
        <% itensDaUltimaCompra.forEach(item => { 
            let grad = (item.categoria === 'Higiene') ? 'linear-gradient(135deg, #00d2ff, #3a7bd5)' : (item.categoria === 'Alimentos') ? 'linear-gradient(135deg, #ff9966, #ff5e62)' : 'linear-gradient(135deg, #43e97b, #38f9d7)';
        %>
        <div class="activity-item">
          <div class="activity-avatar" style="background: <%= grad %>; color: white; display: flex; align-items: center; justify-content: center; padding: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 8v4l3 3"></path>
            </svg>
          </div>
          <div class="activity-content">
            <p class="activity-text"><strong><%= item.nome %></strong>. <%= item.quantidade %> <%= item.unidade %>.</p>
            <span class="activity-time">R$ <%= item.valorTotalItem.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></span>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <div class="glass-card activity-card">
      <div class="card-header">
        <h2 class="card-title">Pr√≥xima compra <%= textoDiasMercado %></h2>
        <p class="card-subtitle">Gasto: <strong>R$ <%= gastoPrevisto.toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></strong></p>
      </div>
      <div class="activity-list">
        <% listaSugestaoCompra.forEach(item => { 
            const qto = Math.max(0, item.quantidade_ideal - item.estoqueEstimado);
        %>
        <div class="activity-item">
          <div class="activity-avatar" style="background: var(--glass-border); color: white; display: flex; align-items: center; justify-content: center; padding: 8px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" />
            </svg></div>
          <div class="activity-content">
            <p class="activity-text"><strong>Comprar <%= qto.toFixed(1) %> <%= item.unidade_medida %></strong> de <%= item.nome %></p>
            <span class="activity-time"><%= item.percentualAtual %>% em estoque</span>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

  </section>
</div>
